name: deploy

on:
  workflow_call:
  workflow_dispatch:

permissions:
  contents: write
  id-token: write  # REQUIRED for trusted publishing

jobs:
  # Job 1: Test release su TestPyPI
  test-release:
    name: Test Release to TestPyPI
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install Poetry
        run: |
          pip install poetry
          poetry self add poetry-plugin-export

      - name: Build package
        run: poetry build

      - name: Publish to TestPyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/
          skip-existing: true
          verbose: true

      - name: Test installation from TestPyPI
        run: |
          sleep 60  # aspetta che il pacchetto sia disponibile
          pip install --index-url https://test.pypi.org/simple/ \
                      --extra-index-url https://pypi.org/simple/ \
                      unibo-dtm-se-2425-OrecchietTetris
          python -c "import OrecchietTetris; print('âœ“ Import successful')"

  # Job 2: Release semantico e pubblicazione su PyPI
  release:
    name: Release to PyPI
    needs: test-release
    runs-on: ubuntu-latest
    concurrency:
      group: deploy
      cancel-in-progress: false

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Poetry
        run: |
          pip install poetry
          poetry self add poetry-plugin-export

      - name: Install dependencies
        run: poetry install --no-interaction

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Install semantic-release
        run: |
          npm install -g \
            semantic-release@^23.0.0 \
            @semantic-release/changelog@^6.0.0 \
            @semantic-release/exec@^6.0.0 \
            @semantic-release/git@^10.0.0

      - name: Run semantic-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GIT_AUTHOR_NAME: github-actions[bot]
          GIT_AUTHOR_EMAIL: github-actions[bot]@users.noreply.github.com
          GIT_COMMITTER_NAME: github-actions[bot]
          GIT_COMMITTER_EMAIL: github-actions[bot]@users.noreply.github.com
        run: |
          git config user.name "${GIT_AUTHOR_NAME}"
          git config user.email "${GIT_AUTHOR_EMAIL}"
          npx semantic-release

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          verbose: true